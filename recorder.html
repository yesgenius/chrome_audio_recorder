<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Audio Recorder (PCM 16kHz 16-bit Mono)</title>
</head>
<body>
  <h1>Audio Recorder to WAV (PCM 16kHz 16-bit Mono)</h1>
  
  <!-- Status area for messages -->
  <p id="status">Checking recording capabilities...</p>
  
  <!-- Button to start/stop recording -->
  <button id="recordBtn" disabled>Record</button>

  <!-- Area for displaying actual settings and other info -->
  <pre id="info"></pre>

  <!-- Script for Recorder.js library -->
  <script src="https://yesgenius.github.io/chrome_audio_recorder/recorder.js"></script>
  
  <script>
    /**
     * Professional-level JavaScript code with English comments
     * ------------------------------------------
     * This code demonstrates audio recording in Chrome on Android 14,
     * capturing raw PCM data (16-bit, 16kHz, mono) without any DSP (noise suppression,
     * echo cancellation, auto gain control, etc.). The recorded audio is saved as a WAV file.
     */

    // Global references
    let audioContext;
    let mediaStream;
    let mediaStreamSource;
    let recorder;

    // Flag to track recording state
    let isRecording = false;

    // Select DOM elements
    const statusEl   = document.getElementById('status');
    const recordBtn  = document.getElementById('recordBtn');
    const infoEl     = document.getElementById('info');

    /**
     * 1 - Check if the recording is possible.
     *    If not possible, display detailed info and terminate.
     */
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      statusEl.textContent = "Recording is not supported by this browser.";
      infoEl.textContent = "Reason: navigator.mediaDevices.getUserMedia is not available.";
      // We stop execution by disabling the button and returning
      recordBtn.disabled = true;
    } else {
      // We have at least some possibility to record
      // Let's proceed to ask for audio stream with constraints
      checkRecordingCapabilities();
    }

    /**
     * checkRecordingCapabilities()
     * Attempts to get audio stream with advanced constraints to disable any processing.
     */
    async function checkRecordingCapabilities() {
      // 2 - Build constraints to disable all known distortions in Chrome.
      const constraints = {
        audio: {
          channelCount: 1,
          sampleRate: 16000,       // Request 16kHz
          sampleSize: 16,          // 16-bit
          echoCancellation: false,
          noiseSuppression: false,
          autoGainControl: false,
          // These "goog*" constraints are non-standard but recognized by Chrome
          // to ensure no internal DSP is applied.
          googEchoCancellation: false,
          googAutoGainControl: false,
          googNoiseSuppression: false,
          googHighpassFilter: false,
          googTypingNoiseDetection: false
        },
        video: false
      };

      try {
        // Request user media with the given constraints
        mediaStream = await navigator.mediaDevices.getUserMedia(constraints);

        // Create an AudioContext
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Create a MediaStreamSource from the captured mediaStream
        mediaStreamSource = audioContext.createMediaStreamSource(mediaStream);

        // 2 - Create a new Recorder object with relevant settings
        //    The Recorder.js library may accept config like { numChannels: 1, ... }.
        //    We'll request single channel, 16-bit, 16kHz inside the WAV container.
        recorder = new Recorder(mediaStreamSource, {
          numChannels: 1,   // 1 channel (mono)
          // The bit rate "256kBit" is effectively 16bits * 16000 Hz = 256 kbps
        });

        // 3 - Display actual constraints on screen for clarity
        // We'll show the constraints we used. 
        // (In real usage, you might also confirm actual sample rate from audioContext, etc.)
        infoEl.textContent = `Actual Constraints / Settings:\n\n${JSON.stringify(constraints.audio, null, 2)}`;

        // Update status and enable record button
        statusEl.textContent = "Ready to record.";
        recordBtn.disabled = false;

      } catch (error) {
        // If we cannot get user media or constraints are not satisfied, display reason and stop.
        statusEl.textContent = "Cannot record audio.";
        infoEl.textContent = `Error details:\n${error.message}\n\n` + 
                             `Your device or browser may not support the required audio constraints.`;
        recordBtn.disabled = true;
      }
    }

    /**
     * getWAVFileName()
     * Returns a string in the format YYYY-MM-DD_HHMMSS.WAV
     */
    function getWAVFileName() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      return `${year}-${month}-${day}_${hours}${minutes}${seconds}.WAV`;
    }

    /**
     * startRecording()
     * Begins recording via Recorder.js
     */
    function startRecording() {
      // Start recording
      recorder.record();
      statusEl.textContent = "Recording started...";
    }

    /**
     * stopRecording()
     * Stops recording and prepares the WAV blob for download.
     */
    function stopRecording() {
      recorder.stop();

      // Export the WAV file
      recorder.exportWAV((blob) => {
        // Prepare file link
        const url = URL.createObjectURL(blob);
        const filename = getWAVFileName();
        
        // Create a temporary link to trigger download
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        // Append link to body (necessary for some browsers)
        document.body.appendChild(link);
        link.click();
        // Clean up
        document.body.removeChild(link);
        
        statusEl.textContent = `Recording stopped. File saved as: ${filename}`;

        // After exporting, we can clear the recorder to reuse it if we want
        recorder.clear();
      });
    }

    /**
     * set up record button click event
     * toggles between start and stop.
     */
    recordBtn.addEventListener('click', () => {
      if (!isRecording) {
        // 4 - First click: start recording
        startRecording();
        recordBtn.textContent = "Stop";
        isRecording = true;
      } else {
        // 5 - Second click: stop recording
        stopRecording();
        recordBtn.textContent = "Запись";
        isRecording = false;
      }
    });
  </script>
</body>
</html>
